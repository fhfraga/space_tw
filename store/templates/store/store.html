{% extends 'store/main.html' %}
{% load static %}
{% block content %}
<div class="container mx-auto mt-10">
    <h1 class="text-center text-2xl text-sky-900 mb-6 font font-sans font-bold uppercase">Ofertas especiais</h1>
    <div class="flex flex-wrap justify-center gap-6">
        {% for product in products %}
        {% if product.on_sale %}
        <div class="relative bg-white shadow-lg rounded-lg overflow-hidden border">
            <img class="w-full h-48 object-cover" src="{{product.imageURL}}" alt="{{product.name}}">
            <div class="p-4">
                <span class="absolute top-0 left-0 bg-red-500 text-white py-1 px-3 rounded-br-lg">Oferta</span>
                <div class="flex justify-end">
                    <h6 class="font-bold text-gray-800 text-lg uppercase">{{product.name}}</h6>
                </div>
                <hr class="my-2">
                <div class="flex justify-between items-center">
                    <div class="flex justify-between items-center mb-4">
                        <button data-product="{{product.id}}" data-action="add"
                            class="bg-sky-950 hover:bg-sky-900 text-white font-bold py-2 px-4 rounded-lg focus:outline-none update-cart mr-4">
                            Alugar
                        </button>
                        <a href="{{product.link}}" class="bg-sky-950 hover:bg-sky-900 text-white font-bold py-2 px-4 rounded-lg focus:outline-none text-center">
                            Sobre
                        </a>
                    </div>
                    <h4 class="text-right text-xl text-gray-600 font-bold">R${{product.price}}/h</h4>                
                </div>
                <p class="mt-2 text-gray-600">
                    <span class="bg-gray-200 text-gray-700 py-1 px-3 rounded-full">{{product.get_space_type_display}}</span>
                </p>
        
                {% if product.features %}
                <p class="text-gray-600 mt-2"><strong>Características:</strong> {{product.features}}</p>
                {% endif %}
        
                {% if product.available_from and product.available_to %}
                <p class="text-gray-600 mt-2">
                    <strong>Disponível de:</strong> {{ product.available_from|date:"d/m/Y" }}
                    <strong>até:</strong> {{ product.available_to|date:"d/m/Y" }}
                </p>
                {% else %}
                <p class="text-gray-600 mt-2"><strong>Disponibilidade não definida.</strong></p>
                {% endif %}
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>
</div>

<script>
    var updateBtns = document.getElementsByClassName('update-cart')

    for (var i = 0; i < updateBtns.length; i++) {
        updateBtns[i].addEventListener('click', function() {
            var productId = this.dataset.product
            var action = this.dataset.action

            if (user == 'AnonymousUser') {
                alert('Você precisa estar logado para alugar uma sala.')
                window.location.href = 'login'
            } else {
                addProductToCart(productId)
            }
        })
    }

    function addProductToCart(productId) {
        var url = '/add_to_cart/'

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({'productId': productId}),
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'added') {
                alert(data.message)
                // Atualizar o contador do carrinho, se necessário
            } else if (data.status === 'exists') {
                alert(data.message)
            } else if (data.status === 'not_authenticated') {
                window.location.href = '/login/'
            }
        })
    }
</script>
{% endblock content %}